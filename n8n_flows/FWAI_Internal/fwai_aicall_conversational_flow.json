{
  "name": "FWAI AI Call - Conversational Flow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "conv-start-call",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "trigger-start-call",
      "name": "Start Call Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "conv-start-call"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://34.93.142.172:3001/call/conversational",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  \"phoneNumber\": $json.body?.phoneNumber || $json.phoneNumber,\n  \"contactName\": $json.body?.contactName || $json.contactName || \"Customer\",\n  \"n8nWebhookUrl\": \"https://n8n.srv1100770.hstgr.cloud/webhook/conv-transcript\",\n  \"callEndWebhookUrl\": \"https://n8n.srv1100770.hstgr.cloud/webhook/conv-call-ended\",\n  \"context\": {\n    \"customer_name\": $json.body?.contactName || $json.contactName || \"Customer\",\n    \"lead_source\": $json.body?.leadSource || $json.leadSource || \"masterclass\"\n  }\n}) }}",
        "options": {}
      },
      "id": "start-conversational-call",
      "name": "Start Conversational Call",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "respond-start",
      "name": "Respond - Call Started",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "conv-transcript",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "transcript-webhook",
      "name": "Transcript Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 520],
      "webhookId": "conv-transcript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "user-speech",
              "leftValue": "={{ $json.body?.role || $json.role }}",
              "rightValue": "user",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-user-speech",
      "name": "Filter User Speech",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [460, 520]
    },
    {
      "parameters": {
        "jsCode": "// FWAI Conversational Flow - State Machine with 12 Discovery Questions\n\nconst rawData = $input.first().json;\nconst data = rawData.body || rawData;\nconst text = (data.text || '').toLowerCase();\nconst callId = data.call_uuid || 'unknown';\n\n// Get current state\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.callStates) staticData.callStates = {};\n\nconst currentState = staticData.callStates[callId] || { \n  phase: 'opening', \n  data: {},\n  turn_count: 0,\n  sentiment: 'neutral',\n  domain: null,\n  objections: []\n};\n\ncurrentState.turn_count++;\nlet nextPhase = null;\nlet capturedData = currentState.data || {};\n\n// Domain detection\nfunction detectDomain(t) {\n  if (t.match(/finance|accounting|banking|fp.a|chartered|ca /i)) return 'finance';\n  if (t.match(/developer|software|engineer|coding|python|java|devops|btech|mca/i)) return 'it';\n  if (t.match(/marketing|seo|social media|content|brand|advertising/i)) return 'marketing';\n  if (t.match(/student|studying|college|university|pursuing|fresher/i)) return 'student';\n  if (t.match(/teacher|professor|lecturer|teaching|education/i)) return 'education';\n  return null;\n}\n\n// Experience extraction\nfunction getExperience(t) {\n  const m = t.match(/(\\d+)\\s*(?:years?|yrs?)/i);\n  return m ? parseInt(m[1]) : null;\n}\n\n// AI rating extraction\nfunction getAIRating(t) {\n  const m = t.match(/(\\d+)\\s*(?:out of|\\/)\\s*10/i) || t.match(/^\\s*(\\d+)\\s*$/);\n  if (m) {\n    const n = parseInt(m[1]);\n    if (n >= 1 && n <= 10) return n;\n  }\n  if (t.includes('beginner')) return 3;\n  if (t.includes('intermediate')) return 5;\n  if (t.includes('advanced')) return 8;\n  return null;\n}\n\n// Sentiment tracking\nfunction getSentiment(t, current) {\n  let score = current === 'positive' ? 1 : (current === 'negative' ? -1 : 0);\n  if (t.match(/yes|great|good|interested|sure|amazing|love|excited/)) score += 0.5;\n  if (t.match(/no|not interested|busy|expensive|can't|won't/)) score -= 0.5;\n  if (t.match(/maybe|think|not sure|need to|discuss/)) score -= 0.2;\n  return score > 0.5 ? 'positive' : (score < -0.5 ? 'negative' : 'neutral');\n}\n\ncurrentState.sentiment = getSentiment(text, currentState.sentiment);\n\n// Detect domain\nconst domain = detectDomain(text);\nif (domain && !currentState.domain) {\n  currentState.domain = domain;\n  capturedData.domain = domain;\n}\n\n// === OBJECTION HANDLING (Priority) ===\nif (text.match(/father|mother|parent|family|husband|wife/) && text.match(/ask|discuss|talk|tell/)) {\n  if (!currentState.objections.includes('family')) {\n    nextPhase = 'objection_family';\n    currentState.objections.push('family');\n  }\n} else if (text.match(/\\bexam\\b|\\btest\\b|\\bsemester\\b/)) {\n  if (!currentState.objections.includes('exams')) {\n    nextPhase = 'objection_exams';\n    capturedData.has_exams = true;\n    currentState.objections.push('exams');\n  }\n} else if (text.match(/price|cost|expensive|afford|budget|how much/)) {\n  if (!currentState.objections.includes('price')) {\n    nextPhase = 'objection_price';\n    currentState.objections.push('price');\n  }\n} else if (text.match(/youtube|free/) && text.match(/learn/)) {\n  if (!currentState.objections.includes('youtube')) {\n    nextPhase = 'objection_youtube';\n    currentState.objections.push('youtube');\n  }\n} else if (text.match(/call.*later|call.*back|call.*tomorrow|busy/)) {\n  nextPhase = 'objection_callback';\n  capturedData.needs_callback = true;\n  if (text.includes('evening')) capturedData.callback_time = 'evening';\n  else if (text.includes('morning')) capturedData.callback_time = 'morning';\n  else if (text.includes('tomorrow')) capturedData.callback_time = 'tomorrow';\n} else if (text.match(/not interested|no thanks|don't want/)) {\n  nextPhase = 'objection_not_interested';\n}\n\n// === PHASE TRANSITIONS ===\nif (!nextPhase) {\n  switch (currentState.phase) {\n    case 'opening':\n      capturedData.registration_reason = text;\n      if (text.match(/good|great|loved|amazing|helpful|excellent/)) nextPhase = 'connection_liked';\n      else if (text.match(/okay|fine|alright/)) nextPhase = 'connection_neutral';\n      else if (text.match(/not good|bad|didn't like|don't remember|boring/)) nextPhase = 'connection_dislike';\n      else nextPhase = 'connection_probe';\n      break;\n      \n    case 'connection_liked':\n    case 'connection_neutral':\n    case 'connection_dislike':\n    case 'connection_probe':\n      nextPhase = 'discovery_expectations';\n      break;\n      \n    case 'discovery_expectations':\n      capturedData.expectations = text;\n      nextPhase = 'discovery_source';\n      break;\n      \n    case 'discovery_source':\n      capturedData.lead_source = text;\n      if (text.includes('youtube')) capturedData.lead_source_type = 'youtube';\n      else if (text.includes('instagram')) capturedData.lead_source_type = 'instagram';\n      else if (text.includes('facebook')) capturedData.lead_source_type = 'facebook';\n      else if (text.includes('friend') || text.includes('referred')) capturedData.lead_source_type = 'referral';\n      else capturedData.lead_source_type = 'other';\n      nextPhase = 'discovery_knowledge_fwai';\n      break;\n      \n    case 'discovery_knowledge_fwai':\n      capturedData.fwai_knowledge = text;\n      capturedData.fwai_awareness = text.length < 20 ? 'low' : 'medium';\n      nextPhase = 'discovery_ai_understanding';\n      break;\n      \n    case 'discovery_ai_understanding':\n      capturedData.ai_understanding = text;\n      nextPhase = 'discovery_ai_rating';\n      break;\n      \n    case 'discovery_ai_rating':\n      capturedData.ai_knowledge_rating = getAIRating(text) || 5;\n      nextPhase = 'situation_ai_usage';\n      break;\n      \n    case 'situation_ai_usage':\n      capturedData.uses_ai = text.match(/yes|using|chatgpt|gemini|claude|copilot/) ? true : false;\n      nextPhase = 'discovery_ai_importance';\n      break;\n      \n    case 'discovery_ai_importance':\n      capturedData.sees_ai_important = text.match(/yes|important|essential|must/) ? true : false;\n      if (text.includes('self') || text.includes('youtube')) capturedData.learning_plan = 'self_study';\n      else if (text.includes('course') || text.includes('mentor')) capturedData.learning_plan = 'guided';\n      nextPhase = 'discovery_ai_result';\n      break;\n      \n    case 'discovery_ai_result':\n      capturedData.desired_result = text;\n      if (text.match(/job|placement|hire/)) capturedData.primary_goal = 'job';\n      else if (text.match(/income|money|earn|freelance/)) capturedData.primary_goal = 'passive_income';\n      else if (text.match(/promotion|hike|salary/)) capturedData.primary_goal = 'career_growth';\n      else capturedData.primary_goal = 'upskilling';\n      nextPhase = 'situation_role';\n      break;\n      \n    case 'situation_role':\n      capturedData.role_description = text;\n      const exp = getExperience(text);\n      if (exp) capturedData.experience_years = exp;\n      if (text.match(/student|studying|college/)) {\n        capturedData.profile_type = 'student';\n        nextPhase = 'situation_student_year';\n      } else {\n        capturedData.profile_type = 'working';\n        nextPhase = exp ? 'discovery_long_term_goal' : 'situation_experience';\n      }\n      break;\n      \n    case 'situation_student_year':\n      capturedData.student_year = text;\n      nextPhase = 'discovery_long_term_goal';\n      break;\n      \n    case 'situation_experience':\n      capturedData.experience_years = getExperience(text) || 0;\n      nextPhase = 'discovery_long_term_goal';\n      break;\n      \n    case 'discovery_long_term_goal':\n      capturedData.long_term_goal = text;\n      if (text.match(/senior|manager|lead|director/)) capturedData.goal_type = 'senior_role';\n      else if (text.match(/business|own|startup|entrepreneur/)) capturedData.goal_type = 'entrepreneurship';\n      else if (text.match(/freelance|independent|consultant/)) capturedData.goal_type = 'freelancing';\n      else capturedData.goal_type = 'career_growth';\n      nextPhase = 'discovery_roadmap';\n      break;\n      \n    case 'discovery_roadmap':\n      capturedData.has_roadmap = text.match(/yes|have|following/) ? true : false;\n      capturedData.needs_guidance = text.match(/no|don't have|looking for|need/) ? true : false;\n      nextPhase = capturedData.needs_guidance ? 'presentation_overview' : 'pain_career';\n      break;\n      \n    case 'pain_career':\n    case 'pain_job_market':\n      capturedData.pain_point = text;\n      nextPhase = 'presentation_overview';\n      break;\n      \n    case 'presentation_overview':\n      nextPhase = text.includes('?') ? 'presentation_details' : 'presentation_benefits';\n      break;\n      \n    case 'presentation_details':\n      nextPhase = 'presentation_benefits';\n      break;\n      \n    case 'presentation_benefits':\n      // Qualify lead\n      const years = capturedData.experience_years || 0;\n      const isWorking = capturedData.profile_type === 'working';\n      const needsGuide = capturedData.needs_guidance;\n      const sentiment = currentState.sentiment;\n      \n      if (years >= 3 && isWorking && sentiment === 'positive') nextPhase = 'closing_hot';\n      else if ((years >= 1 && isWorking) || sentiment !== 'negative') nextPhase = 'closing_warm';\n      else nextPhase = 'closing_cold';\n      break;\n      \n    case 'objection_family':\n    case 'objection_need_time':\n      nextPhase = 'followup_schedule';\n      break;\n      \n    case 'objection_exams':\n      nextPhase = 'presentation_flexibility';\n      break;\n      \n    case 'presentation_flexibility':\n      nextPhase = currentState.sentiment === 'positive' ? 'closing_warm' : 'followup_schedule';\n      break;\n      \n    case 'objection_price':\n    case 'objection_youtube':\n      nextPhase = 'presentation_benefits';\n      break;\n      \n    case 'objection_callback':\n      nextPhase = 'followup_confirm';\n      break;\n      \n    case 'followup_schedule':\n      if (text.includes('evening')) capturedData.callback_time = 'evening';\n      else if (text.includes('morning')) capturedData.callback_time = 'morning';\n      else if (text.includes('tomorrow')) capturedData.callback_time = 'tomorrow';\n      nextPhase = 'followup_confirm';\n      break;\n      \n    case 'followup_confirm':\n      capturedData.followup_scheduled = true;\n      nextPhase = 'closing_scheduled';\n      break;\n      \n    case 'closing_hot':\n    case 'closing_warm':\n      if (text.match(/interested|join|enroll|sign up/)) nextPhase = 'closing_payment';\n      else if (text.match(/think|decide|later/)) nextPhase = 'followup_schedule';\n      break;\n      \n    case 'closing_payment':\n      nextPhase = 'closing_complete';\n      break;\n  }\n}\n\n// Save state\nif (nextPhase) {\n  staticData.callStates[callId] = {\n    phase: nextPhase,\n    data: capturedData,\n    turn_count: currentState.turn_count,\n    sentiment: currentState.sentiment,\n    domain: currentState.domain,\n    objections: currentState.objections\n  };\n}\n\nreturn {\n  call_uuid: callId,\n  text: text,\n  current_phase: currentState.phase,\n  next_phase: nextPhase,\n  captured_data: capturedData,\n  sentiment: currentState.sentiment,\n  domain: currentState.domain,\n  turn_count: currentState.turn_count,\n  should_inject: nextPhase !== null\n};"
      },
      "id": "analyze-intent",
      "name": "Analyze Intent (State Machine)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 520]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-inject",
              "leftValue": "={{ $json.should_inject }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-inject",
      "name": "Should Inject?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [900, 520]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://34.93.142.172:3001/call/inject/{{ $json.call_uuid }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  \"phase\": $json.next_phase,\n  \"context\": \"\",\n  \"data\": $json.captured_data,\n  \"sentiment\": $json.sentiment,\n  \"domain\": $json.domain\n}) }}",
        "options": {}
      },
      "id": "inject-phase",
      "name": "Inject Phase",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 460]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "conv-call-ended",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "call-ended-webhook",
      "name": "Call Ended Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 740],
      "webhookId": "conv-call-ended"
    },
    {
      "parameters": {
        "jsCode": "// Process call end\nconst rawData = $input.first().json;\nconst data = rawData.body || rawData;\nconst callId = data.call_uuid || 'unknown';\n\nconst staticData = $getWorkflowStaticData('global');\nconst callStates = staticData.callStates || {};\nconst finalState = callStates[callId] || { phase: 'unknown', data: {}, sentiment: 'neutral', turn_count: 0 };\n\n// Determine lead type\nlet leadType = 'cold';\nif (finalState.phase?.includes('hot') || finalState.phase === 'closing_payment') leadType = 'hot';\nelse if (finalState.phase?.includes('warm') || finalState.sentiment === 'positive') leadType = 'warm';\nelse if (finalState.phase === 'closing_scheduled' || finalState.data?.followup_scheduled) leadType = 'scheduled';\n\n// Clean up\ndelete callStates[callId];\nstaticData.callStates = callStates;\n\nreturn {\n  call_uuid: callId,\n  caller_phone: data.caller_phone,\n  duration_seconds: data.duration_seconds,\n  transcript: data.transcript,\n  lead_type: leadType,\n  final_phase: finalState.phase,\n  total_turns: finalState.turn_count,\n  sentiment: finalState.sentiment,\n  domain: finalState.domain,\n  captured_data: finalState.data,\n  summary: {\n    profile_type: finalState.data?.profile_type || 'Unknown',\n    domain: finalState.domain || 'General',\n    experience: finalState.data?.experience_years || 0,\n    goal: finalState.data?.primary_goal || 'Not captured',\n    callback_time: finalState.data?.callback_time || null\n  }\n};"
      },
      "id": "process-call-end",
      "name": "Process Call End",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 740]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-hot",
              "leftValue": "={{ $json.lead_type }}",
              "rightValue": "hot",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-hot-lead",
      "name": "Is Hot Lead?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 740]
    },
    {
      "parameters": {
        "jsCode": "// HOT LEAD\nconst data = $input.first().json;\nreturn {\n  action: 'immediate_callback',\n  priority: 'HIGH',\n  lead_type: 'HOT',\n  data: data.summary,\n  message: `ðŸ”¥ HOT LEAD: ${data.summary.profile_type} - ${data.summary.domain}`\n};"
      },
      "id": "handle-hot-lead",
      "name": "Handle Hot Lead",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 680]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-scheduled",
              "leftValue": "={{ $json.lead_type }}",
              "rightValue": "scheduled",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-scheduled",
      "name": "Is Scheduled?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [900, 800]
    },
    {
      "parameters": {
        "jsCode": "// SCHEDULED CALLBACK\nconst data = $input.first().json;\nreturn {\n  action: 'schedule_callback',\n  priority: 'SCHEDULED',\n  callback_time: data.summary.callback_time,\n  data: data.summary,\n  message: `ðŸ“… CALLBACK: ${data.summary.callback_time}`\n};"
      },
      "id": "handle-scheduled",
      "name": "Handle Scheduled",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 740]
    },
    {
      "parameters": {
        "jsCode": "// WARM/COLD LEAD\nconst data = $input.first().json;\nreturn {\n  action: data.lead_type === 'warm' ? 'nurture' : 'archive',\n  priority: data.lead_type === 'warm' ? 'MEDIUM' : 'LOW',\n  lead_type: data.lead_type.toUpperCase(),\n  data: data.summary,\n  message: `${data.lead_type === 'warm' ? 'ðŸŸ¡' : 'âšª'} ${data.lead_type.toUpperCase()}: ${data.summary.profile_type}`\n};"
      },
      "id": "handle-other",
      "name": "Handle Warm/Cold",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 860]
    }
  ],
  "connections": {
    "Start Call Trigger": {
      "main": [[{"node": "Start Conversational Call", "type": "main", "index": 0}]]
    },
    "Start Conversational Call": {
      "main": [[{"node": "Respond - Call Started", "type": "main", "index": 0}]]
    },
    "Transcript Webhook": {
      "main": [[{"node": "Filter User Speech", "type": "main", "index": 0}]]
    },
    "Filter User Speech": {
      "main": [[{"node": "Analyze Intent (State Machine)", "type": "main", "index": 0}]]
    },
    "Analyze Intent (State Machine)": {
      "main": [[{"node": "Should Inject?", "type": "main", "index": 0}]]
    },
    "Should Inject?": {
      "main": [[{"node": "Inject Phase", "type": "main", "index": 0}]]
    },
    "Call Ended Webhook": {
      "main": [[{"node": "Process Call End", "type": "main", "index": 0}]]
    },
    "Process Call End": {
      "main": [[{"node": "Is Hot Lead?", "type": "main", "index": 0}]]
    },
    "Is Hot Lead?": {
      "main": [
        [{"node": "Handle Hot Lead", "type": "main", "index": 0}],
        [{"node": "Is Scheduled?", "type": "main", "index": 0}]
      ]
    },
    "Is Scheduled?": {
      "main": [
        [{"node": "Handle Scheduled", "type": "main", "index": 0}],
        [{"node": "Handle Warm/Cold", "type": "main", "index": 0}]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "global": {
      "callStates": {}
    }
  }
}
